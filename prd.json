{
  "$schema": ".ralph/prd.schema.json",
  "projectName": "sTools",
  "branchName": "ralph",
  "testCommand": "swift test",
  "typecheckCommand": "swift build",
  "lintCommand": "",
  "stories": [
    {
      "id": "S1",
      "title": "Trust Foundations - Manifest, TrustStore, Verifier, Sanitizer",
      "priority": 1,
      "passes": true,
      "description": "Implement manifest schema validation, local trust store management, cryptographic verification (hash + signature), and archive sanitization with size/file-count caps.",
      "acceptanceCriteria": [
        "Manifest schema defined with required fields: name, version, sha256, size, signature, signerKeyId, trustedSigners[], revokedKeys[], builtWith, targets, minAppVersion",
        "TrustStore implemented at ~/Library/Application Support/SkillsInspector/trust.json with allowlist + revocations",
        "Verifier validates Ed25519 signatures and SHA256 hashes; fails closed on mismatch",
        "Sanitizer enforces size cap (50MB default), file-count cap (2000 entries), no symlinks, no absolute paths",
        "Unit tests cover tampered archives, oversized archives, zip-bomb fixtures"
      ]
    },
    {
      "id": "S2",
      "title": "Consentful Preview - Safe Preview API, Download Gate",
      "priority": 2,
      "passes": true,
      "description": "API-based safe preview labeled 'Safe preview from server'; explicit 'Download and verify' consent gate; size/MIME limits; UX wiring with provenance badges.",
      "acceptanceCriteria": [
        "Preview API client fetches metadata without writing SKILL.md to disk; labeled 'Safe preview from server'",
        "Explicit 'Download and verify' CTA with progress indication and failure reasons",
        "Provenance badge shows verified/unknown/failing status with human-readable signer",
        "Trust prompt: 'Trust signer for this skill' with per-skill cache",
        "Size/MIME limits enforced before download"
      ]
    },
    {
      "id": "S3",
      "title": "Pinned Publishing - Vendor CLI with Checksum, Deterministic Zip",
      "priority": 3,
      "passes": true,
      "description": "Replace bunx ...@latest with pinned version plus checksum; produce deterministic zip with recorded build info; emit signed attestation.",
      "acceptanceCriteria": [
        "Publish command uses pinned tool version with checksum (SRI hash)",
        "Tool hash recorded in build metadata",
        "Deterministic zip output produces identical hash for same inputs",
        "Signed attestation (in-toto style manifest) stored alongside artifact",
        "Dry-run mode supported for testing",
        "Pin clawdhub@0.1.0 with integrity sha512-LZ0mRf61F5SjgprrMwgyLRqMOKxC5sQZYF1tZGgZCawiaVfb79A8cp0Fl32/JNRqiRI7TB0/EuPJPMJ4evmK0g=="
      ]
    },
    {
      "id": "S4",
      "title": "Ledger + Changelog - Append-Only Log, Rollback",
      "priority": 4,
      "passes": true,
      "description": "Local append-only SQLite ledger of installs/updates/removals with version, hash, signer; auto-generate markdown changelog; rollback support.",
      "acceptanceCriteria": [
        "SQLite ledger schema: events(id, ts, action, skill_id, version, hash, signer_key_id, source, result, targets, per_target_results, notes)",
        "Ledger is append-only; entries cannot be deleted",
        "Markdown changelog generator produces per-skill changelog from ledger entries",
        "Rollback restores last-good version on failure",
        "All install/update/remove operations logged"
      ]
    },
    {
      "id": "S5",
      "title": "Remote Detail Caching + Preview Panel",
      "priority": 5,
      "passes": true,
      "description": "Cache SKILL.md/changelog metadata to avoid repeated downloads; surface provenance badges in list + detail; cache TTL/eviction policy.",
      "acceptanceCriteria": [
        "Detail side-panel shows inline SKILL.md preview, changelog, and signer provenance before download",
        "Cache validates against manifest hash; expires by ETag/time",
        "Cache TTL: 7 days or 50MB cap",
        "Provenance badges visible in both list and detail views",
        "Split-view navigation with local/remote source toggle"
      ]
    },
    {
      "id": "S6",
      "title": "Adapters MVP - Codex, Claude Code, GitHub Copilot",
      "priority": 6,
      "passes": true,
      "description": "Adapter layer writes validated artifacts to ~/.codex/skills, ~/.claude/skills, ~/.copilot/skills; post-install validation hooks; ledger records per-target results.",
      "acceptanceCriteria": [
        "Codex adapter writes to existing sTools skill layout",
        "Claude Code adapter writes to ~/.claude/skills/",
        "GitHub Copilot adapter writes to ~/.copilot/skills/",
        "Post-install validation hooks per target",
        "Ledger records success/failure per IDE target",
        "Atomic install: stage to temp, then move; rollback on adapter failure"
      ]
    },
    {
      "id": "S7",
      "title": "Telemetry Stub + Privacy Notice",
      "priority": 7,
      "passes": true,
      "description": "Opt-in telemetry capturing counts of verified installs, blocked downloads, publish runs; anonymized; retained locally for 30 days.",
      "acceptanceCriteria": [
        "Telemetry off by default; opt-in via feature flag",
        "Capture counts: verified installs, blocked downloads, publish runs",
        "Include app version and anonymized install ID; no PII",
        "Retain telemetry locally for 30 days",
        "Privacy notice displayed when enabling telemetry",
        "Paths and user identifiers redacted from logs"
      ]
    },
    {
      "id": "S8",
      "title": "Skill Maintainer - Pinned Reproducible Publishing",
      "priority": 8,
      "passes": true,
      "description": "As a maintainer, I want publishing to use a pinned, reproducible toolchain so consumers get identical artifacts.",
      "acceptanceCriteria": [
        "Publish command respects pinned tool version from config",
        "Build metadata includes tool version, hash, timestamp",
        "Deterministic output verified via hash comparison",
        "Attestation file includes all build inputs"
      ]
    },
    {
      "id": "S9",
      "title": "Security-Conscious Developer - Verified Installs with Provenance",
      "priority": 9,
      "passes": true,
      "description": "As a developer, I want installs to fail closed on signature mismatch and show provenance so I can trust what I run.",
      "acceptanceCriteria": [
        "Install fails closed (no files written) on signature/hash mismatch",
        "Provenance badge shows signer key ID and verification status",
        "Clear error messages explain verification failures",
        "Trust prompt allows per-skill signer approval"
      ]
    },
    {
      "id": "S10",
      "title": "Evaluator - Safe Preview Without Disk Write",
      "priority": 10,
      "passes": true,
      "description": "As an evaluator, I want to preview SKILL.md without writing to disk until I consent, so browsing is safe.",
      "acceptanceCriteria": [
        "Preview fetches SKILL.md content via API without downloading archive",
        "Preview labeled 'Safe preview from server'",
        "No files written to disk until user clicks 'Download and verify'",
        "Preview shown in detail side-panel"
      ]
    },
    {
      "id": "S11",
      "title": "Cross-IDE User - Unified Install Across IDEs",
      "priority": 11,
      "passes": true,
      "description": "As a user, I want one install to register the skill for Codex, Claude Code, and Copilot so I don't repeat steps.",
      "acceptanceCriteria": [
        "Single install command targets all configured IDEs",
        "UI shows per-target registration status",
        "Failed targets don't block successful targets",
        "Ledger records per-target results",
        "Cross-IDE registration success rate >=90%"
      ]
    },
    {
      "id": "S12",
      "title": "Auditor - Signed Changelog of Installs/Updates",
      "priority": 12,
      "passes": true,
      "description": "As an auditor, I need a signed changelog of installs/updates with versions and hashes so I can trace incidents.",
      "acceptanceCriteria": [
        "Ledger records all installs/updates/removals with version, hash, signer key",
        "Markdown changelog export includes all ledger entries",
        "Export includes signer provenance for each entry",
        "Changelog can be filtered by skill, date range, action type",
        "Audit trail is tamper-evident (append-only)"
      ]
    },
    {
      "id": "S13",
      "title": "Bulk Actions Toolbar",
      "priority": 13,
      "passes": true,
      "description": "Toolbar actions for bulk operations: Verify All, Update All Verified, Export Changelog.",
      "acceptanceCriteria": [
        "'Verify All' triggers verification for all installed skills",
        "'Update All Verified' updates only skills with valid signatures",
        "'Export Changelog' generates markdown file of all ledger entries",
        "Progress indication for bulk operations",
        "Error handling continues on individual failures"
      ]
    },
    {
      "id": "S14",
      "title": "Feature Flags and Governance",
      "priority": 14,
      "passes": true,
      "description": "Feature flags: skillVerification, pinnedPublishing, crossIDEAdapters, telemetryOptIn, bulkActions. ORR/Launch checklists.",
      "acceptanceCriteria": [
        "Feature flags: skillVerification, pinnedPublishing, crossIDEAdapters, telemetryOptIn, bulkActions",
        "Flags configurable via config.json",
        "ADRs documented: artifact trust model, publishing tool pinning, adapter layout, preview cache policy",
        "ORR checklist completed before verification-by-default",
        "Launch checklist completed before stable release"
      ]
    }
  ]
}
